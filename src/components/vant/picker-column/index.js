'use strict';

var _component = require('./../common/component.js');

var _utils = require('./../common/utils.js');

var DEFAULT_DURATION = 200;
(0, _component.VantComponent)({
  classes: ['active-class'],
  props: {
    valueKey: String,
    className: String,
    itemHeight: Number,
    visibleItemCount: Number,
    initialOptions: {
      type: Array,
      value: []
    },
    defaultIndex: {
      type: Number,
      value: 0
    }
  },
  data: {
    startY: 0,
    offset: 0,
    duration: 0,
    startOffset: 0,
    options: [],
    currentIndex: 0
  },
  beforeCreate: function beforeCreate() {
    var _this = this;

    var _this$data = this.data,
        defaultIndex = _this$data.defaultIndex,
        initialOptions = _this$data.initialOptions;
    this.set({
      currentIndex: defaultIndex,
      options: initialOptions
    }).then(function () {
      _this.setIndex(defaultIndex);
    });
  },
  computed: {
    count: function count() {
      return this.data.options.length;
    },
    baseOffset: function baseOffset() {
      var data = this.data;
      return data.itemHeight * (data.visibleItemCount - 1) / 2;
    },
    wrapperStyle: function wrapperStyle() {
      var data = this.data;
      return ["transition: " + data.duration + "ms", "transform: translate3d(0, " + (data.offset + data.baseOffset) + "px, 0)", "line-height: " + data.itemHeight + "px"].join('; ');
    }
  },
  watch: {
    defaultIndex: function defaultIndex(value) {
      this.setIndex(value);
    }
  },
  methods: {
    onTouchStart: function onTouchStart(event) {
      this.set({
        startY: event.touches[0].clientY,
        startOffset: this.data.offset,
        duration: 0
      });
    },
    onTouchMove: function onTouchMove(event) {
      var data = this.data;
      var deltaY = event.touches[0].clientY - data.startY;
      this.set({
        offset: (0, _utils.range)(data.startOffset + deltaY, -(data.count * data.itemHeight), data.itemHeight)
      });
    },
    onTouchEnd: function onTouchEnd() {
      var data = this.data;

      if (data.offset !== data.startOffset) {
        this.set({
          duration: DEFAULT_DURATION
        });
        var index = (0, _utils.range)(Math.round(-data.offset / data.itemHeight), 0, data.count - 1);
        this.setIndex(index, true);
      }
    },
    onClickItem: function onClickItem(event) {
      var index = event.currentTarget.dataset.index;
      this.setIndex(index, true);
    },
    adjustIndex: function adjustIndex(index) {
      var data = this.data;
      index = (0, _utils.range)(index, 0, data.count);

      for (var i = index; i < data.count; i++) {
        if (!this.isDisabled(data.options[i])) return i;
      }

      for (var _i = index - 1; _i >= 0; _i--) {
        if (!this.isDisabled(data.options[_i])) return _i;
      }
    },
    isDisabled: function isDisabled(option) {
      return (0, _utils.isObj)(option) && option.disabled;
    },
    getOptionText: function getOptionText(option) {
      var data = this.data;
      return (0, _utils.isObj)(option) && data.valueKey in option ? option[data.valueKey] : option;
    },
    setIndex: function setIndex(index, userAction) {
      var _this2 = this;

      var data = this.data;
      index = this.adjustIndex(index) || 0;
      var offset = -index * data.itemHeight;

      if (index !== data.currentIndex) {
        return this.set({
          offset: offset,
          currentIndex: index
        }).then(function () {
          userAction && _this2.$emit('change', index);
        });
      } else {
        return this.set({
          offset: offset
        });
      }
    },
    setValue: function setValue(value) {
      var options = this.data.options;

      for (var i = 0; i < options.length; i++) {
        if (this.getOptionText(options[i]) === value) {
          return this.setIndex(i);
        }
      }

      return Promise.resolve();
    },
    getValue: function getValue() {
      var data = this.data;
      return data.options[data.currentIndex];
    }
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIkRFRkFVTFRfRFVSQVRJT04iLCJjbGFzc2VzIiwicHJvcHMiLCJ2YWx1ZUtleSIsIlN0cmluZyIsImNsYXNzTmFtZSIsIml0ZW1IZWlnaHQiLCJOdW1iZXIiLCJ2aXNpYmxlSXRlbUNvdW50IiwiaW5pdGlhbE9wdGlvbnMiLCJ0eXBlIiwiQXJyYXkiLCJ2YWx1ZSIsImRlZmF1bHRJbmRleCIsImRhdGEiLCJzdGFydFkiLCJvZmZzZXQiLCJkdXJhdGlvbiIsInN0YXJ0T2Zmc2V0Iiwib3B0aW9ucyIsImN1cnJlbnRJbmRleCIsImJlZm9yZUNyZWF0ZSIsIl90aGlzIiwiX3RoaXMkZGF0YSIsInNldCIsInRoZW4iLCJzZXRJbmRleCIsImNvbXB1dGVkIiwiY291bnQiLCJsZW5ndGgiLCJiYXNlT2Zmc2V0Iiwid3JhcHBlclN0eWxlIiwiam9pbiIsIndhdGNoIiwibWV0aG9kcyIsIm9uVG91Y2hTdGFydCIsImV2ZW50IiwidG91Y2hlcyIsImNsaWVudFkiLCJvblRvdWNoTW92ZSIsImRlbHRhWSIsIm9uVG91Y2hFbmQiLCJpbmRleCIsIk1hdGgiLCJyb3VuZCIsIm9uQ2xpY2tJdGVtIiwiY3VycmVudFRhcmdldCIsImRhdGFzZXQiLCJhZGp1c3RJbmRleCIsImkiLCJpc0Rpc2FibGVkIiwiX2kiLCJvcHRpb24iLCJkaXNhYmxlZCIsImdldE9wdGlvblRleHQiLCJ1c2VyQWN0aW9uIiwiX3RoaXMyIiwiJGVtaXQiLCJzZXRWYWx1ZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2V0VmFsdWUiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0EsSUFBSUEsbUJBQW1CLEdBQXZCO0FBQ0EsOEJBQWM7QUFDWkMsV0FBUyxDQUFDLGNBQUQsQ0FERztBQUVaQyxTQUFPO0FBQ0xDLGNBQVVDLE1BREw7QUFFTEMsZUFBV0QsTUFGTjtBQUdMRSxnQkFBWUMsTUFIUDtBQUlMQyxzQkFBa0JELE1BSmI7QUFLTEUsb0JBQWdCO0FBQ2RD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QVUsU0FBU0EsUUFBVCxHQUFvQjtBQUM1QixVQUFJL0MsT0FBTyxLQUFLQSxJQUFoQjtBQUNBLGFBQU9BLEtBQUtLLE9BQUwsQ0FBYUwsS0FBS00sWUFBbEIsQ0FBUDtBQUNEO0FBbkZNO0FBdkRHLENBQWQiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBWYW50Q29tcG9uZW50IH0gZnJvbSAnLi4vY29tbW9uL2NvbXBvbmVudCc7XG5pbXBvcnQgeyBpc09iaiwgcmFuZ2UgfSBmcm9tICcuLi9jb21tb24vdXRpbHMnO1xudmFyIERFRkFVTFRfRFVSQVRJT04gPSAyMDA7XG5WYW50Q29tcG9uZW50KHtcbiAgY2xhc3NlczogWydhY3RpdmUtY2xhc3MnXSxcbiAgcHJvcHM6IHtcbiAgICB2YWx1ZUtleTogU3RyaW5nLFxuICAgIGNsYXNzTmFtZTogU3RyaW5nLFxuICAgIGl0ZW1IZWlnaHQ6IE51bWJlcixcbiAgICB2aXNpYmxlSXRlbUNvdW50OiBOdW1iZXIsXG4gICAgaW5pdGlhbE9wdGlvbnM6IHtcbiAgICAgIHR5cGU6IEFycmF5LFxuICAgICAgdmFsdWU6IFtdXG4gICAgfSxcbiAgICBkZWZhdWx0SW5kZXg6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHZhbHVlOiAwXG4gICAgfVxuICB9LFxuICBkYXRhOiB7XG4gICAgc3RhcnRZOiAwLFxuICAgIG9mZnNldDogMCxcbiAgICBkdXJhdGlvbjogMCxcbiAgICBzdGFydE9mZnNldDogMCxcbiAgICBvcHRpb25zOiBbXSxcbiAgICBjdXJyZW50SW5kZXg6IDBcbiAgfSxcbiAgYmVmb3JlQ3JlYXRlOiBmdW5jdGlvbiBiZWZvcmVDcmVhdGUoKSB7XG4gICAgdmFyIF90aGlzID0gdGhpcztcblxuICAgIHZhciBfdGhpcyRkYXRhID0gdGhpcy5kYXRhLFxuICAgICAgICBkZWZhdWx0SW5kZXggPSBfdGhpcyRkYXRhLmRlZmF1bHRJbmRleCxcbiAgICAgICAgaW5pdGlhbE9wdGlvbnMgPSBfdGhpcyRkYXRhLmluaXRpYWxPcHRpb25zO1xuICAgIHRoaXMuc2V0KHtcbiAgICAgIGN1cnJlbnRJbmRleDogZGVmYXVsdEluZGV4LFxuICAgICAgb3B0aW9uczogaW5pdGlhbE9wdGlvbnNcbiAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgIF90aGlzLnNldEluZGV4KGRlZmF1bHRJbmRleCk7XG4gICAgfSk7XG4gIH0sXG4gIGNvbXB1dGVkOiB7XG4gICAgY291bnQ6IGZ1bmN0aW9uIGNvdW50KCkge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YS5vcHRpb25zLmxlbmd0aDtcbiAgICB9LFxuICAgIGJhc2VPZmZzZXQ6IGZ1bmN0aW9uIGJhc2VPZmZzZXQoKSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHJldHVybiBkYXRhLml0ZW1IZWlnaHQgKiAoZGF0YS52aXNpYmxlSXRlbUNvdW50IC0gMSkgLyAyO1xuICAgIH0sXG4gICAgd3JhcHBlclN0eWxlOiBmdW5jdGlvbiB3cmFwcGVyU3R5bGUoKSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHJldHVybiBbXCJ0cmFuc2l0aW9uOiBcIiArIGRhdGEuZHVyYXRpb24gKyBcIm1zXCIsIFwidHJhbnNmb3JtOiB0cmFuc2xhdGUzZCgwLCBcIiArIChkYXRhLm9mZnNldCArIGRhdGEuYmFzZU9mZnNldCkgKyBcInB4LCAwKVwiLCBcImxpbmUtaGVpZ2h0OiBcIiArIGRhdGEuaXRlbUhlaWdodCArIFwicHhcIl0uam9pbignOyAnKTtcbiAgICB9XG4gIH0sXG4gIHdhdGNoOiB7XG4gICAgZGVmYXVsdEluZGV4OiBmdW5jdGlvbiBkZWZhdWx0SW5kZXgodmFsdWUpIHtcbiAgICAgIHRoaXMuc2V0SW5kZXgodmFsdWUpO1xuICAgIH1cbiAgfSxcbiAgbWV0aG9kczoge1xuICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24gb25Ub3VjaFN0YXJ0KGV2ZW50KSB7XG4gICAgICB0aGlzLnNldCh7XG4gICAgICAgIHN0YXJ0WTogZXZlbnQudG91Y2hlc1swXS5jbGllbnRZLFxuICAgICAgICBzdGFydE9mZnNldDogdGhpcy5kYXRhLm9mZnNldCxcbiAgICAgICAgZHVyYXRpb246IDBcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgb25Ub3VjaE1vdmU6IGZ1bmN0aW9uIG9uVG91Y2hNb3ZlKGV2ZW50KSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHZhciBkZWx0YVkgPSBldmVudC50b3VjaGVzWzBdLmNsaWVudFkgLSBkYXRhLnN0YXJ0WTtcbiAgICAgIHRoaXMuc2V0KHtcbiAgICAgICAgb2Zmc2V0OiByYW5nZShkYXRhLnN0YXJ0T2Zmc2V0ICsgZGVsdGFZLCAtKGRhdGEuY291bnQgKiBkYXRhLml0ZW1IZWlnaHQpLCBkYXRhLml0ZW1IZWlnaHQpXG4gICAgICB9KTtcbiAgICB9LFxuICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uIG9uVG91Y2hFbmQoKSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcblxuICAgICAgaWYgKGRhdGEub2Zmc2V0ICE9PSBkYXRhLnN0YXJ0T2Zmc2V0KSB7XG4gICAgICAgIHRoaXMuc2V0KHtcbiAgICAgICAgICBkdXJhdGlvbjogREVGQVVMVF9EVVJBVElPTlxuICAgICAgICB9KTtcbiAgICAgICAgdmFyIGluZGV4ID0gcmFuZ2UoTWF0aC5yb3VuZCgtZGF0YS5vZmZzZXQgLyBkYXRhLml0ZW1IZWlnaHQpLCAwLCBkYXRhLmNvdW50IC0gMSk7XG4gICAgICAgIHRoaXMuc2V0SW5kZXgoaW5kZXgsIHRydWUpO1xuICAgICAgfVxuICAgIH0sXG4gICAgb25DbGlja0l0ZW06IGZ1bmN0aW9uIG9uQ2xpY2tJdGVtKGV2ZW50KSB7XG4gICAgICB2YXIgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXg7XG4gICAgICB0aGlzLnNldEluZGV4KGluZGV4LCB0cnVlKTtcbiAgICB9LFxuICAgIGFkanVzdEluZGV4OiBmdW5jdGlvbiBhZGp1c3RJbmRleChpbmRleCkge1xuICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICBpbmRleCA9IHJhbmdlKGluZGV4LCAwLCBkYXRhLmNvdW50KTtcblxuICAgICAgZm9yICh2YXIgaSA9IGluZGV4OyBpIDwgZGF0YS5jb3VudDsgaSsrKSB7XG4gICAgICAgIGlmICghdGhpcy5pc0Rpc2FibGVkKGRhdGEub3B0aW9uc1tpXSkpIHJldHVybiBpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKHZhciBfaSA9IGluZGV4IC0gMTsgX2kgPj0gMDsgX2ktLSkge1xuICAgICAgICBpZiAoIXRoaXMuaXNEaXNhYmxlZChkYXRhLm9wdGlvbnNbX2ldKSkgcmV0dXJuIF9pO1xuICAgICAgfVxuICAgIH0sXG4gICAgaXNEaXNhYmxlZDogZnVuY3Rpb24gaXNEaXNhYmxlZChvcHRpb24pIHtcbiAgICAgIHJldHVybiBpc09iaihvcHRpb24pICYmIG9wdGlvbi5kaXNhYmxlZDtcbiAgICB9LFxuICAgIGdldE9wdGlvblRleHQ6IGZ1bmN0aW9uIGdldE9wdGlvblRleHQob3B0aW9uKSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHJldHVybiBpc09iaihvcHRpb24pICYmIGRhdGEudmFsdWVLZXkgaW4gb3B0aW9uID8gb3B0aW9uW2RhdGEudmFsdWVLZXldIDogb3B0aW9uO1xuICAgIH0sXG4gICAgc2V0SW5kZXg6IGZ1bmN0aW9uIHNldEluZGV4KGluZGV4LCB1c2VyQWN0aW9uKSB7XG4gICAgICB2YXIgX3RoaXMyID0gdGhpcztcblxuICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICBpbmRleCA9IHRoaXMuYWRqdXN0SW5kZXgoaW5kZXgpIHx8IDA7XG4gICAgICB2YXIgb2Zmc2V0ID0gLWluZGV4ICogZGF0YS5pdGVtSGVpZ2h0O1xuXG4gICAgICBpZiAoaW5kZXggIT09IGRhdGEuY3VycmVudEluZGV4KSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNldCh7XG4gICAgICAgICAgb2Zmc2V0OiBvZmZzZXQsXG4gICAgICAgICAgY3VycmVudEluZGV4OiBpbmRleFxuICAgICAgICB9KS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICB1c2VyQWN0aW9uICYmIF90aGlzMi4kZW1pdCgnY2hhbmdlJywgaW5kZXgpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNldCh7XG4gICAgICAgICAgb2Zmc2V0OiBvZmZzZXRcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBzZXRWYWx1ZTogZnVuY3Rpb24gc2V0VmFsdWUodmFsdWUpIHtcbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5kYXRhLm9wdGlvbnM7XG5cbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAodGhpcy5nZXRPcHRpb25UZXh0KG9wdGlvbnNbaV0pID09PSB2YWx1ZSkge1xuICAgICAgICAgIHJldHVybiB0aGlzLnNldEluZGV4KGkpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9LFxuICAgIGdldFZhbHVlOiBmdW5jdGlvbiBnZXRWYWx1ZSgpIHtcbiAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgcmV0dXJuIGRhdGEub3B0aW9uc1tkYXRhLmN1cnJlbnRJbmRleF07XG4gICAgfVxuICB9XG59KTsiXX0=