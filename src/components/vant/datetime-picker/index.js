'use strict';

var _component = require('./../common/component.js');

var _utils = require('./../common/utils.js');

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var currentYear = new Date().getFullYear();

function isValidDate(date) {
  return (0, _utils.isDef)(date) && !isNaN(new Date(date).getTime());
}

function range(num, min, max) {
  return Math.min(Math.max(num, min), max);
}

function padZero(val) {
  return ("00" + val).slice(-2);
}

function times(n, iteratee) {
  var index = -1;
  var result = Array(n);

  while (++index < n) {
    result[index] = iteratee(index);
  }

  return result;
}

function getTrueValue(formattedValue) {
  if (!formattedValue) return;

  while (isNaN(parseInt(formattedValue, 10))) {
    formattedValue = formattedValue.slice(1);
  }

  return parseInt(formattedValue, 10);
}

function getMonthEndDay(year, month) {
  return 32 - new Date(year, month - 1, 32).getDate();
}

(0, _component.VantComponent)({
  props: {
    value: null,
    title: String,
    loading: Boolean,
    itemHeight: {
      type: Number,
      value: 44
    },
    visibleItemCount: {
      type: Number,
      value: 5
    },
    confirmButtonText: {
      type: String,
      value: '确认'
    },
    cancelButtonText: {
      type: String,
      value: '取消'
    },
    type: {
      type: String,
      value: 'datetime'
    },
    showToolbar: {
      type: Boolean,
      value: true
    },
    minDate: {
      type: Number,
      value: new Date(currentYear - 10, 0, 1).getTime()
    },
    maxDate: {
      type: Number,
      value: new Date(currentYear + 10, 11, 31).getTime()
    },
    minHour: {
      type: Number,
      value: 0
    },
    maxHour: {
      type: Number,
      value: 23
    },
    minMinute: {
      type: Number,
      value: 0
    },
    maxMinute: {
      type: Number,
      value: 59
    }
  },
  data: {
    innerValue: Date.now(),
    columns: []
  },
  watch: {
    value: function value(val) {
      var _this = this;

      var data = this.data;
      val = this.correctValue(val);
      var isEqual = val === data.innerValue;

      if (!isEqual) {
        this.updateColumnValue(val).then(function () {
          _this.$emit('input', val);
        });
      }
    },
    type: 'updateColumns',
    minHour: 'updateColumns',
    maxHour: 'updateColumns',
    minMinute: 'updateColumns',
    maxMinute: 'updateColumns'
  },
  methods: {
    getPicker: function getPicker() {
      if (this.picker == null) {
        var picker = this.picker = this.selectComponent('.van-datetime-picker');
        var setColumnValues = picker.setColumnValues;

        picker.setColumnValues = function () {
          for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
            args[_key] = arguments[_key];
          }

          return setColumnValues.apply(picker, [].concat(args, [false]));
        };
      }

      return this.picker;
    },
    updateColumns: function updateColumns() {
      var results = this.getRanges().map(function (_ref, index) {
        var type = _ref.type,
            range = _ref.range;
        var values = times(range[1] - range[0] + 1, function (index) {
          var value = range[0] + index;
          value = type === 'year' ? "" + value : padZero(value);
          return value;
        });
        return {
          values: values
        };
      });
      return this.set({
        columns: results
      });
    },
    getRanges: function getRanges() {
      var data = this.data;

      if (data.type === 'time') {
        return [{
          type: 'hour',
          range: [data.minHour, data.maxHour]
        }, {
          type: 'minute',
          range: [data.minMinute, data.maxMinute]
        }];
      }

      var _this$getBoundary = this.getBoundary('max', data.innerValue),
          maxYear = _this$getBoundary.maxYear,
          maxDate = _this$getBoundary.maxDate,
          maxMonth = _this$getBoundary.maxMonth,
          maxHour = _this$getBoundary.maxHour,
          maxMinute = _this$getBoundary.maxMinute;

      var _this$getBoundary2 = this.getBoundary('min', data.innerValue),
          minYear = _this$getBoundary2.minYear,
          minDate = _this$getBoundary2.minDate,
          minMonth = _this$getBoundary2.minMonth,
          minHour = _this$getBoundary2.minHour,
          minMinute = _this$getBoundary2.minMinute;

      var result = [{
        type: 'year',
        range: [minYear, maxYear]
      }, {
        type: 'month',
        range: [minMonth, maxMonth]
      }, {
        type: 'day',
        range: [minDate, maxDate]
      }, {
        type: 'hour',
        range: [minHour, maxHour]
      }, {
        type: 'minute',
        range: [minMinute, maxMinute]
      }];
      if (data.type === 'date') result.splice(3, 2);
      if (data.type === 'year-month') result.splice(2, 3);
      return result;
    },
    correctValue: function correctValue(value) {
      var data = this.data; // validate value

      var isDateType = data.type !== 'time';

      if (isDateType && !isValidDate(value)) {
        value = data.minDate;
      } else if (!isDateType && !value) {
        var minHour = data.minHour;
        value = padZero(minHour) + ":00";
      } // time type


      if (!isDateType) {
        var _value$split = value.split(':'),
            hour = _value$split[0],
            minute = _value$split[1];

        hour = padZero(range(hour, data.minHour, data.maxHour));
        minute = padZero(range(minute, data.minMinute, data.maxMinute));
        return hour + ":" + minute;
      } // date type


      value = Math.max(value, data.minDate);
      value = Math.min(value, data.maxDate);
      return value;
    },
    getBoundary: function getBoundary(type, innerValue) {
      var _ref2;

      var value = new Date(innerValue);
      var boundary = new Date(this.data[type + "Date"]);
      var year = boundary.getFullYear();
      var month = 1;
      var date = 1;
      var hour = 0;
      var minute = 0;

      if (type === 'max') {
        month = 12;
        date = getMonthEndDay(value.getFullYear(), value.getMonth() + 1);
        hour = 23;
        minute = 59;
      }

      if (value.getFullYear() === year) {
        month = boundary.getMonth() + 1;

        if (value.getMonth() + 1 === month) {
          date = boundary.getDate();

          if (value.getDate() === date) {
            hour = boundary.getHours();

            if (value.getHours() === hour) {
              minute = boundary.getMinutes();
            }
          }
        }
      }

      return _ref2 = {}, _defineProperty(_ref2, type + "Year", year), _defineProperty(_ref2, type + "Month", month), _defineProperty(_ref2, type + "Date", date), _defineProperty(_ref2, type + "Hour", hour), _defineProperty(_ref2, type + "Minute", minute), _ref2;
    },
    onCancel: function onCancel() {
      this.$emit('cancel');
    },
    onConfirm: function onConfirm() {
      this.$emit('confirm', this.data.innerValue);
    },
    onChange: function onChange() {
      var _this2 = this;

      var data = this.data;
      var value;
      var picker = this.getPicker();

      if (data.type === 'time') {
        var indexes = picker.getIndexes();
        value = indexes[0] + data.minHour + ":" + (indexes[1] + data.minMinute);
      } else {
        var values = picker.getValues();
        var year = getTrueValue(values[0]);
        var month = getTrueValue(values[1]);
        var maxDate = getMonthEndDay(year, month);
        var date = getTrueValue(values[2]);

        if (data.type === 'year-month') {
          date = 1;
        }

        date = date > maxDate ? maxDate : date;
        var hour = 0;
        var minute = 0;

        if (data.type === 'datetime') {
          hour = getTrueValue(values[3]);
          minute = getTrueValue(values[4]);
        }

        value = new Date(year, month - 1, date, hour, minute);
      }

      value = this.correctValue(value);
      this.updateColumnValue(value).then(function () {
        _this2.$emit('input', value);

        _this2.$emit('change', picker);
      });
    },
    updateColumnValue: function updateColumnValue(value) {
      var _this3 = this;

      var values = [];
      var data = this.data;
      var picker = this.getPicker();

      if (data.type === 'time') {
        var pair = value.split(':');
        values = [pair[0], pair[1]];
      } else {
        var date = new Date(value);
        values = ["" + date.getFullYear(), padZero(date.getMonth() + 1)];

        if (data.type === 'date') {
          values.push(padZero(date.getDate()));
        }

        if (data.type === 'datetime') {
          values.push(padZero(date.getDate()), padZero(date.getHours()), padZero(date.getMinutes()));
        }
      }

      return this.set({
        innerValue: value
      }).then(function () {
        return _this3.updateColumns();
      }).then(function () {
        return picker.setValues(values);
      });
    }
  },
  created: function created() {
    var _this4 = this;

    var innerValue = this.correctValue(this.data.value);
    this.updateColumnValue(innerValue).then(function () {
      _this4.$emit('input', innerValue);
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImN1cnJlbnRZZWFyIiwiRGF0ZSIsImdldEZ1bGxZZWFyIiwiaXNWYWxpZERhdGUiLCJkYXRlIiwiaXNOYU4iLCJnZXRUaW1lIiwicmFuZ2UiLCJudW0iLCJtaW4iLCJtYXgiLCJNYXRoIiwicGFkWmVybyIsInZhbCIsInNsaWNlIiwidGltZXMiLCJuIiwiaXRlcmF0ZWUiLCJpbmRleCIsInJlc3VsdCIsIkFycmF5IiwiZ2V0VHJ1ZVZhbHVlIiwiZm9ybWF0dGVkVmFsdWUiLCJwYXJzZUludCIsImdldE1vbnRoRW5kRGF5IiwieWVhciIsIm1vbnRoIiwiZ2V0RGF0ZSIsInByb3BzIiwidmFsdWUiLCJ0aXRsZSIsIlN0cmluZyIsImxvYWRpbmciLCJCb29sZWFuIiwiaXRlbUhlaWdodCIsInR5cGUiLCJOdW1iZXIiLCJ2aXNpYmxlSXRlbUNvdW50IiwiY29uZmlybUJ1dHRvblRleHQiLCJjYW5jZWxCdXR0b25UZXh0Iiwic2hvd1Rvb2xiYXIiLCJtaW5EYXRlIiwibWF4RGF0ZSIsIm1pbkhvdXIiLCJtYXhIb3VyIiwibWluTWludXRlIiwibWF4TWludXRlIiwiZGF0YSIsImlubmVyVmFsdWUiLCJub3ciLCJjb2x1bW5zIiwid2F0Y2giLCJfdGhpcyIsImNvcnJlY3RWYWx1ZSIsImlzRXF1YWwiLCJ1cGRhdGVDb2x1bW5WYWx1ZSIsInRoZW4iLCIkZW1pdCIsIm1ldGhvZHMiLCJnZXRQaWNrZXIiLCJwaWNrZXIiLCJzZWxlY3RDb21wb25lbnQiLCJzZXRDb2x1bW5WYWx1ZXMiLCJfbGVuIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiYXJncyIsIl9rZXkiLCJhcHBseSIsImNvbmNhdCIsInVwZGF0ZUNvbHVtbnMiLCJyZXN1bHRzIiwiZ2V0UmFuZ2VzIiwibWFwIiwiX3JlZiIsInZhbHVlcyIsInNldCIsIl90aGlzJGdldEJvdW5kYXJ5IiwiZ2V0Qm91bmRhcnkiLCJtYXhZZWFyIiwibWF4TW9udGgiLCJfdGhpcyRnZXRCb3VuZGFyeTIiLCJtaW5ZZWFyIiwibWluTW9udGgiLCJzcGxpY2UiLCJpc0RhdGVUeXBlIiwiX3ZhbHVlJHNwbGl0Iiwic3BsaXQiLCJob3VyIiwibWludXRlIiwiYm91bmRhcnkiLCJnZXRNb250aCIsImdldEhvdXJzIiwiZ2V0TWludXRlcyIsIm9uQ2FuY2VsIiwib25Db25maXJtIiwib25DaGFuZ2UiLCJfdGhpczIiLCJpbmRleGVzIiwiZ2V0SW5kZXhlcyIsImdldFZhbHVlcyIsIl90aGlzMyIsInBhaXIiLCJwdXNoIiwic2V0VmFsdWVzIiwiY3JlYXRlZCIsIl90aGlzNCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7QUFDQTs7OztBQUNBLElBQUlBLGNBQWMsSUFBSUMsSUFBSixHQUFXQyxXQUFYLEVBQWxCOztBQUVBLFNBQVNDLFdBQVQsQ0FBcUJDLElBQXJCLEVBQTJCO0FBQ3pCLFNBQU8sa0JBQU1BLElBQU4sS0FBZSxDQUFDQyxNQUFNLElBQUlKLElBQUosQ0FBU0csSUFBVCxFQUFlRSxPQUFmLEVBQU4sQ0FBdkI7QUFDRDs7QUFFRCxTQUFTQyxLQUFULENBQWVDLEdBQWYsRUFBb0JDLEdBQXBCLEVBQXlCQyxHQUF6QixFQUE4QjtBQUM1QixTQUFPQyxLQUFLRixHQUFMLENBQVNFLEtBQUtELEdBQUwsQ0FBU0YsR0FBVCxFQUFjQyxHQUFkLENBQVQsRUFBNkJDLEdBQTdCLENBQVA7QUFDRDs7QUFFRCxTQUFTRSxPQUFULENBQWlCQyxHQUFqQixFQUFzQjtBQUNwQixTQUFPLENBQUMsT0FBT0EsR0FBUixFQUFhQyxLQUFiLENBQW1CLENBQUMsQ0FBcEIsQ0FBUDtBQUNEOztBQUVELFNBQVNDLEtBQVQsQ0FBZUMsQ0FBZixFQUFrQkMsUUFBbEIsRUFBNEI7QUFDMUIsTUFBSUMsUUFBUSxDQUFDLENBQWI7QUFDQSxNQUFJQyxTQUFTQyxNQUFNSixDQUFOLENBQWI7O0FBRUEsU0FBTyxFQUFFRSxLQUFGLEdBQVVGLENBQWpCLEVBQW9CO0FBQ2xCRyxXQUFPRCxLQUFQLElBQWdCRCxTQUFTQyxLQUFULENB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QixNQUFqQixDQUFQO0FBQ0QsT0FOTSxDQUFQO0FBT0Q7QUFqT00sR0E5RUc7QUFpVFo4QixXQUFTLFNBQVNBLE9BQVQsR0FBbUI7QUFDMUIsUUFBSUMsU0FBUyxJQUFiOztBQUVBLFFBQUkxRCxhQUFhLEtBQUtLLFlBQUwsQ0FBa0IsS0FBS04sSUFBTCxDQUFVbEIsS0FBNUIsQ0FBakI7QUFDQSxTQUFLMEIsaUJBQUwsQ0FBdUJQLFVBQXZCLEVBQW1DUSxJQUFuQyxDQUF3QyxZQUFZO0FBQ2xEa0QsYUFBT2pELEtBQVAsQ0FBYSxPQUFiLEVBQXNCVCxVQUF0QjtBQUNELEtBRkQ7QUFHRDtBQXhUVyxDQUFkIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmFudENvbXBvbmVudCB9IGZyb20gJy4uL2NvbW1vbi9jb21wb25lbnQnO1xuaW1wb3J0IHsgaXNEZWYgfSBmcm9tICcuLi9jb21tb24vdXRpbHMnO1xudmFyIGN1cnJlbnRZZWFyID0gbmV3IERhdGUoKS5nZXRGdWxsWWVhcigpO1xuXG5mdW5jdGlvbiBpc1ZhbGlkRGF0ZShkYXRlKSB7XG4gIHJldHVybiBpc0RlZihkYXRlKSAmJiAhaXNOYU4obmV3IERhdGUoZGF0ZSkuZ2V0VGltZSgpKTtcbn1cblxuZnVuY3Rpb24gcmFuZ2UobnVtLCBtaW4sIG1heCkge1xuICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgobnVtLCBtaW4pLCBtYXgpO1xufVxuXG5mdW5jdGlvbiBwYWRaZXJvKHZhbCkge1xuICByZXR1cm4gKFwiMDBcIiArIHZhbCkuc2xpY2UoLTIpO1xufVxuXG5mdW5jdGlvbiB0aW1lcyhuLCBpdGVyYXRlZSkge1xuICB2YXIgaW5kZXggPSAtMTtcbiAgdmFyIHJlc3VsdCA9IEFycmF5KG4pO1xuXG4gIHdoaWxlICgrK2luZGV4IDwgbikge1xuICAgIHJlc3VsdFtpbmRleF0gPSBpdGVyYXRlZShpbmRleCk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBnZXRUcnVlVmFsdWUoZm9ybWF0dGVkVmFsdWUpIHtcbiAgaWYgKCFmb3JtYXR0ZWRWYWx1ZSkgcmV0dXJuO1xuXG4gIHdoaWxlIChpc05hTihwYXJzZUludChmb3JtYXR0ZWRWYWx1ZSwgMTApKSkge1xuICAgIGZvcm1hdHRlZFZhbHVlID0gZm9ybWF0dGVkVmFsdWUuc2xpY2UoMSk7XG4gIH1cblxuICByZXR1cm4gcGFyc2VJbnQoZm9ybWF0dGVkVmFsdWUsIDEwKTtcbn1cblxuZnVuY3Rpb24gZ2V0TW9udGhFbmREYXkoeWVhciwgbW9udGgpIHtcbiAgcmV0dXJuIDMyIC0gbmV3IERhdGUoeWVhciwgbW9udGggLSAxLCAzMikuZ2V0RGF0ZSgpO1xufVxuXG5WYW50Q29tcG9uZW50KHtcbiAgcHJvcHM6IHtcbiAgICB2YWx1ZTogbnVsbCxcbiAgICB0aXRsZTogU3RyaW5nLFxuICAgIGxvYWRpbmc6IEJvb2xlYW4sXG4gICAgaXRlbUhlaWdodDoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IDQ0XG4gICAgfSxcbiAgICB2aXNpYmxlSXRlbUNvdW50OiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICB2YWx1ZTogNVxuICAgIH0sXG4gICAgY29uZmlybUJ1dHRvblRleHQ6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHZhbHVlOiAn56Gu6K6kJ1xuICAgIH0sXG4gICAgY2FuY2VsQnV0dG9uVGV4dDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgdmFsdWU6ICflj5bmtognXG4gICAgfSxcbiAgICB0eXBlOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICB2YWx1ZTogJ2RhdGV0aW1lJ1xuICAgIH0sXG4gICAgc2hvd1Rvb2xiYXI6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICB2YWx1ZTogdHJ1ZVxuICAgIH0sXG4gICAgbWluRGF0ZToge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IG5ldyBEYXRlKGN1cnJlbnRZZWFyIC0gMTAsIDAsIDEpLmdldFRpbWUoKVxuICAgIH0sXG4gICAgbWF4RGF0ZToge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IG5ldyBEYXRlKGN1cnJlbnRZZWFyICsgMTAsIDExLCAzMSkuZ2V0VGltZSgpXG4gICAgfSxcbiAgICBtaW5Ib3VyOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICB2YWx1ZTogMFxuICAgIH0sXG4gICAgbWF4SG91cjoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgdmFsdWU6IDIzXG4gICAgfSxcbiAgICBtaW5NaW51dGU6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHZhbHVlOiAwXG4gICAgfSxcbiAgICBtYXhNaW51dGU6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIHZhbHVlOiA1OVxuICAgIH1cbiAgfSxcbiAgZGF0YToge1xuICAgIGlubmVyVmFsdWU6IERhdGUubm93KCksXG4gICAgY29sdW1uczogW11cbiAgfSxcbiAgd2F0Y2g6IHtcbiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUodmFsKSB7XG4gICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuXG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTtcbiAgICAgIHZhbCA9IHRoaXMuY29ycmVjdFZhbHVlKHZhbCk7XG4gICAgICB2YXIgaXNFcXVhbCA9IHZhbCA9PT0gZGF0YS5pbm5lclZhbHVlO1xuXG4gICAgICBpZiAoIWlzRXF1YWwpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDb2x1bW5WYWx1ZSh2YWwpLnRoZW4oZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzLiRlbWl0KCdpbnB1dCcsIHZhbCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gICAgdHlwZTogJ3VwZGF0ZUNvbHVtbnMnLFxuICAgIG1pbkhvdXI6ICd1cGRhdGVDb2x1bW5zJyxcbiAgICBtYXhIb3VyOiAndXBkYXRlQ29sdW1ucycsXG4gICAgbWluTWludXRlOiAndXBkYXRlQ29sdW1ucycsXG4gICAgbWF4TWludXRlOiAndXBkYXRlQ29sdW1ucydcbiAgfSxcbiAgbWV0aG9kczoge1xuICAgIGdldFBpY2tlcjogZnVuY3Rpb24gZ2V0UGlja2VyKCkge1xuICAgICAgaWYgKHRoaXMucGlja2VyID09IG51bGwpIHtcbiAgICAgICAgdmFyIHBpY2tlciA9IHRoaXMucGlja2VyID0gdGhpcy5zZWxlY3RDb21wb25lbnQoJy52YW4tZGF0ZXRpbWUtcGlja2VyJyk7XG4gICAgICAgIHZhciBzZXRDb2x1bW5WYWx1ZXMgPSBwaWNrZXIuc2V0Q29sdW1uVmFsdWVzO1xuXG4gICAgICAgIHBpY2tlci5zZXRDb2x1bW5WYWx1ZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgZm9yICh2YXIgX2xlbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGFyZ3MgPSBuZXcgQXJyYXkoX2xlbiksIF9rZXkgPSAwOyBfa2V5IDwgX2xlbjsgX2tleSsrKSB7XG4gICAgICAgICAgICBhcmdzW19rZXldID0gYXJndW1lbnRzW19rZXldO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBzZXRDb2x1bW5WYWx1ZXMuYXBwbHkocGlja2VyLCBbXS5jb25jYXQoYXJncywgW2ZhbHNlXSkpO1xuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5waWNrZXI7XG4gICAgfSxcbiAgICB1cGRhdGVDb2x1bW5zOiBmdW5jdGlvbiB1cGRhdGVDb2x1bW5zKCkge1xuICAgICAgdmFyIHJlc3VsdHMgPSB0aGlzLmdldFJhbmdlcygpLm1hcChmdW5jdGlvbiAoX3JlZiwgaW5kZXgpIHtcbiAgICAgICAgdmFyIHR5cGUgPSBfcmVmLnR5cGUsXG4gICAgICAgICAgICByYW5nZSA9IF9yZWYucmFuZ2U7XG4gICAgICAgIHZhciB2YWx1ZXMgPSB0aW1lcyhyYW5nZVsxXSAtIHJhbmdlWzBdICsgMSwgZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICAgICAgdmFyIHZhbHVlID0gcmFuZ2VbMF0gKyBpbmRleDtcbiAgICAgICAgICB2YWx1ZSA9IHR5cGUgPT09ICd5ZWFyJyA/IFwiXCIgKyB2YWx1ZSA6IHBhZFplcm8odmFsdWUpO1xuICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsdWVzOiB2YWx1ZXNcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHRoaXMuc2V0KHtcbiAgICAgICAgY29sdW1uczogcmVzdWx0c1xuICAgICAgfSk7XG4gICAgfSxcbiAgICBnZXRSYW5nZXM6IGZ1bmN0aW9uIGdldFJhbmdlcygpIHtcbiAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuXG4gICAgICBpZiAoZGF0YS50eXBlID09PSAndGltZScpIHtcbiAgICAgICAgcmV0dXJuIFt7XG4gICAgICAgICAgdHlwZTogJ2hvdXInLFxuICAgICAgICAgIHJhbmdlOiBbZGF0YS5taW5Ib3VyLCBkYXRhLm1heEhvdXJdXG4gICAgICAgIH0sIHtcbiAgICAgICAgICB0eXBlOiAnbWludXRlJyxcbiAgICAgICAgICByYW5nZTogW2RhdGEubWluTWludXRlLCBkYXRhLm1heE1pbnV0ZV1cbiAgICAgICAgfV07XG4gICAgICB9XG5cbiAgICAgIHZhciBfdGhpcyRnZXRCb3VuZGFyeSA9IHRoaXMuZ2V0Qm91bmRhcnkoJ21heCcsIGRhdGEuaW5uZXJWYWx1ZSksXG4gICAgICAgICAgbWF4WWVhciA9IF90aGlzJGdldEJvdW5kYXJ5Lm1heFllYXIsXG4gICAgICAgICAgbWF4RGF0ZSA9IF90aGlzJGdldEJvdW5kYXJ5Lm1heERhdGUsXG4gICAgICAgICAgbWF4TW9udGggPSBfdGhpcyRnZXRCb3VuZGFyeS5tYXhNb250aCxcbiAgICAgICAgICBtYXhIb3VyID0gX3RoaXMkZ2V0Qm91bmRhcnkubWF4SG91cixcbiAgICAgICAgICBtYXhNaW51dGUgPSBfdGhpcyRnZXRCb3VuZGFyeS5tYXhNaW51dGU7XG5cbiAgICAgIHZhciBfdGhpcyRnZXRCb3VuZGFyeTIgPSB0aGlzLmdldEJvdW5kYXJ5KCdtaW4nLCBkYXRhLmlubmVyVmFsdWUpLFxuICAgICAgICAgIG1pblllYXIgPSBfdGhpcyRnZXRCb3VuZGFyeTIubWluWWVhcixcbiAgICAgICAgICBtaW5EYXRlID0gX3RoaXMkZ2V0Qm91bmRhcnkyLm1pbkRhdGUsXG4gICAgICAgICAgbWluTW9udGggPSBfdGhpcyRnZXRCb3VuZGFyeTIubWluTW9udGgsXG4gICAgICAgICAgbWluSG91ciA9IF90aGlzJGdldEJvdW5kYXJ5Mi5taW5Ib3VyLFxuICAgICAgICAgIG1pbk1pbnV0ZSA9IF90aGlzJGdldEJvdW5kYXJ5Mi5taW5NaW51dGU7XG5cbiAgICAgIHZhciByZXN1bHQgPSBbe1xuICAgICAgICB0eXBlOiAneWVhcicsXG4gICAgICAgIHJhbmdlOiBbbWluWWVhciwgbWF4WWVhcl1cbiAgICAgIH0sIHtcbiAgICAgICAgdHlwZTogJ21vbnRoJyxcbiAgICAgICAgcmFuZ2U6IFttaW5Nb250aCwgbWF4TW9udGhdXG4gICAgICB9LCB7XG4gICAgICAgIHR5cGU6ICdkYXknLFxuICAgICAgICByYW5nZTogW21pbkRhdGUsIG1heERhdGVdXG4gICAgICB9LCB7XG4gICAgICAgIHR5cGU6ICdob3VyJyxcbiAgICAgICAgcmFuZ2U6IFttaW5Ib3VyLCBtYXhIb3VyXVxuICAgICAgfSwge1xuICAgICAgICB0eXBlOiAnbWludXRlJyxcbiAgICAgICAgcmFuZ2U6IFttaW5NaW51dGUsIG1heE1pbnV0ZV1cbiAgICAgIH1dO1xuICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ2RhdGUnKSByZXN1bHQuc3BsaWNlKDMsIDIpO1xuICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3llYXItbW9udGgnKSByZXN1bHQuc3BsaWNlKDIsIDMpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuICAgIGNvcnJlY3RWYWx1ZTogZnVuY3Rpb24gY29ycmVjdFZhbHVlKHZhbHVlKSB7XG4gICAgICB2YXIgZGF0YSA9IHRoaXMuZGF0YTsgLy8gdmFsaWRhdGUgdmFsdWVcblxuICAgICAgdmFyIGlzRGF0ZVR5cGUgPSBkYXRhLnR5cGUgIT09ICd0aW1lJztcblxuICAgICAgaWYgKGlzRGF0ZVR5cGUgJiYgIWlzVmFsaWREYXRlKHZhbHVlKSkge1xuICAgICAgICB2YWx1ZSA9IGRhdGEubWluRGF0ZTtcbiAgICAgIH0gZWxzZSBpZiAoIWlzRGF0ZVR5cGUgJiYgIXZhbHVlKSB7XG4gICAgICAgIHZhciBtaW5Ib3VyID0gZGF0YS5taW5Ib3VyO1xuICAgICAgICB2YWx1ZSA9IHBhZFplcm8obWluSG91cikgKyBcIjowMFwiO1xuICAgICAgfSAvLyB0aW1lIHR5cGVcblxuXG4gICAgICBpZiAoIWlzRGF0ZVR5cGUpIHtcbiAgICAgICAgdmFyIF92YWx1ZSRzcGxpdCA9IHZhbHVlLnNwbGl0KCc6JyksXG4gICAgICAgICAgICBob3VyID0gX3ZhbHVlJHNwbGl0WzBdLFxuICAgICAgICAgICAgbWludXRlID0gX3ZhbHVlJHNwbGl0WzFdO1xuXG4gICAgICAgIGhvdXIgPSBwYWRaZXJvKHJhbmdlKGhvdXIsIGRhdGEubWluSG91ciwgZGF0YS5tYXhIb3VyKSk7XG4gICAgICAgIG1pbnV0ZSA9IHBhZFplcm8ocmFuZ2UobWludXRlLCBkYXRhLm1pbk1pbnV0ZSwgZGF0YS5tYXhNaW51dGUpKTtcbiAgICAgICAgcmV0dXJuIGhvdXIgKyBcIjpcIiArIG1pbnV0ZTtcbiAgICAgIH0gLy8gZGF0ZSB0eXBlXG5cblxuICAgICAgdmFsdWUgPSBNYXRoLm1heCh2YWx1ZSwgZGF0YS5taW5EYXRlKTtcbiAgICAgIHZhbHVlID0gTWF0aC5taW4odmFsdWUsIGRhdGEubWF4RGF0ZSk7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfSxcbiAgICBnZXRCb3VuZGFyeTogZnVuY3Rpb24gZ2V0Qm91bmRhcnkodHlwZSwgaW5uZXJWYWx1ZSkge1xuICAgICAgdmFyIHZhbHVlID0gbmV3IERhdGUoaW5uZXJWYWx1ZSk7XG4gICAgICB2YXIgYm91bmRhcnkgPSBuZXcgRGF0ZSh0aGlzLmRhdGFbdHlwZSArIFwiRGF0ZVwiXSk7XG4gICAgICB2YXIgeWVhciA9IGJvdW5kYXJ5LmdldEZ1bGxZZWFyKCk7XG4gICAgICB2YXIgbW9udGggPSAxO1xuICAgICAgdmFyIGRhdGUgPSAxO1xuICAgICAgdmFyIGhvdXIgPSAwO1xuICAgICAgdmFyIG1pbnV0ZSA9IDA7XG5cbiAgICAgIGlmICh0eXBlID09PSAnbWF4Jykge1xuICAgICAgICBtb250aCA9IDEyO1xuICAgICAgICBkYXRlID0gZ2V0TW9udGhFbmREYXkodmFsdWUuZ2V0RnVsbFllYXIoKSwgdmFsdWUuZ2V0TW9udGgoKSArIDEpO1xuICAgICAgICBob3VyID0gMjM7XG4gICAgICAgIG1pbnV0ZSA9IDU5O1xuICAgICAgfVxuXG4gICAgICBpZiAodmFsdWUuZ2V0RnVsbFllYXIoKSA9PT0geWVhcikge1xuICAgICAgICBtb250aCA9IGJvdW5kYXJ5LmdldE1vbnRoKCkgKyAxO1xuXG4gICAgICAgIGlmICh2YWx1ZS5nZXRNb250aCgpICsgMSA9PT0gbW9udGgpIHtcbiAgICAgICAgICBkYXRlID0gYm91bmRhcnkuZ2V0RGF0ZSgpO1xuXG4gICAgICAgICAgaWYgKHZhbHVlLmdldERhdGUoKSA9PT0gZGF0ZSkge1xuICAgICAgICAgICAgaG91ciA9IGJvdW5kYXJ5LmdldEhvdXJzKCk7XG5cbiAgICAgICAgICAgIGlmICh2YWx1ZS5nZXRIb3VycygpID09PSBob3VyKSB7XG4gICAgICAgICAgICAgIG1pbnV0ZSA9IGJvdW5kYXJ5LmdldE1pbnV0ZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgW3R5cGUgKyBcIlllYXJcIl06IHllYXIsXG4gICAgICAgIFt0eXBlICsgXCJNb250aFwiXTogbW9udGgsXG4gICAgICAgIFt0eXBlICsgXCJEYXRlXCJdOiBkYXRlLFxuICAgICAgICBbdHlwZSArIFwiSG91clwiXTogaG91cixcbiAgICAgICAgW3R5cGUgKyBcIk1pbnV0ZVwiXTogbWludXRlXG4gICAgICB9O1xuICAgIH0sXG4gICAgb25DYW5jZWw6IGZ1bmN0aW9uIG9uQ2FuY2VsKCkge1xuICAgICAgdGhpcy4kZW1pdCgnY2FuY2VsJyk7XG4gICAgfSxcbiAgICBvbkNvbmZpcm06IGZ1bmN0aW9uIG9uQ29uZmlybSgpIHtcbiAgICAgIHRoaXMuJGVtaXQoJ2NvbmZpcm0nLCB0aGlzLmRhdGEuaW5uZXJWYWx1ZSk7XG4gICAgfSxcbiAgICBvbkNoYW5nZTogZnVuY3Rpb24gb25DaGFuZ2UoKSB7XG4gICAgICB2YXIgX3RoaXMyID0gdGhpcztcblxuICAgICAgdmFyIGRhdGEgPSB0aGlzLmRhdGE7XG4gICAgICB2YXIgdmFsdWU7XG4gICAgICB2YXIgcGlja2VyID0gdGhpcy5nZXRQaWNrZXIoKTtcblxuICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3RpbWUnKSB7XG4gICAgICAgIHZhciBpbmRleGVzID0gcGlja2VyLmdldEluZGV4ZXMoKTtcbiAgICAgICAgdmFsdWUgPSBpbmRleGVzWzBdICsgZGF0YS5taW5Ib3VyICsgXCI6XCIgKyAoaW5kZXhlc1sxXSArIGRhdGEubWluTWludXRlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciB2YWx1ZXMgPSBwaWNrZXIuZ2V0VmFsdWVzKCk7XG4gICAgICAgIHZhciB5ZWFyID0gZ2V0VHJ1ZVZhbHVlKHZhbHVlc1swXSk7XG4gICAgICAgIHZhciBtb250aCA9IGdldFRydWVWYWx1ZSh2YWx1ZXNbMV0pO1xuICAgICAgICB2YXIgbWF4RGF0ZSA9IGdldE1vbnRoRW5kRGF5KHllYXIsIG1vbnRoKTtcbiAgICAgICAgdmFyIGRhdGUgPSBnZXRUcnVlVmFsdWUodmFsdWVzWzJdKTtcblxuICAgICAgICBpZiAoZGF0YS50eXBlID09PSAneWVhci1tb250aCcpIHtcbiAgICAgICAgICBkYXRlID0gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRhdGUgPSBkYXRlID4gbWF4RGF0ZSA/IG1heERhdGUgOiBkYXRlO1xuICAgICAgICB2YXIgaG91ciA9IDA7XG4gICAgICAgIHZhciBtaW51dGUgPSAwO1xuXG4gICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgICAgICBob3VyID0gZ2V0VHJ1ZVZhbHVlKHZhbHVlc1szXSk7XG4gICAgICAgICAgbWludXRlID0gZ2V0VHJ1ZVZhbHVlKHZhbHVlc1s0XSk7XG4gICAgICAgIH1cblxuICAgICAgICB2YWx1ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgZGF0ZSwgaG91ciwgbWludXRlKTtcbiAgICAgIH1cblxuICAgICAgdmFsdWUgPSB0aGlzLmNvcnJlY3RWYWx1ZSh2YWx1ZSk7XG4gICAgICB0aGlzLnVwZGF0ZUNvbHVtblZhbHVlKHZhbHVlKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgX3RoaXMyLiRlbWl0KCdpbnB1dCcsIHZhbHVlKTtcblxuICAgICAgICBfdGhpczIuJGVtaXQoJ2NoYW5nZScsIHBpY2tlcik7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIHVwZGF0ZUNvbHVtblZhbHVlOiBmdW5jdGlvbiB1cGRhdGVDb2x1bW5WYWx1ZSh2YWx1ZSkge1xuICAgICAgdmFyIF90aGlzMyA9IHRoaXM7XG5cbiAgICAgIHZhciB2YWx1ZXMgPSBbXTtcbiAgICAgIHZhciBkYXRhID0gdGhpcy5kYXRhO1xuICAgICAgdmFyIHBpY2tlciA9IHRoaXMuZ2V0UGlja2VyKCk7XG5cbiAgICAgIGlmIChkYXRhLnR5cGUgPT09ICd0aW1lJykge1xuICAgICAgICB2YXIgcGFpciA9IHZhbHVlLnNwbGl0KCc6Jyk7XG4gICAgICAgIHZhbHVlcyA9IFtwYWlyWzBdLCBwYWlyWzFdXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUodmFsdWUpO1xuICAgICAgICB2YWx1ZXMgPSBbXCJcIiArIGRhdGUuZ2V0RnVsbFllYXIoKSwgcGFkWmVybyhkYXRlLmdldE1vbnRoKCkgKyAxKV07XG5cbiAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ2RhdGUnKSB7XG4gICAgICAgICAgdmFsdWVzLnB1c2gocGFkWmVybyhkYXRlLmdldERhdGUoKSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgICAgIHZhbHVlcy5wdXNoKHBhZFplcm8oZGF0ZS5nZXREYXRlKCkpLCBwYWRaZXJvKGRhdGUuZ2V0SG91cnMoKSksIHBhZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5zZXQoe1xuICAgICAgICBpbm5lclZhbHVlOiB2YWx1ZVxuICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBfdGhpczMudXBkYXRlQ29sdW1ucygpO1xuICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBwaWNrZXIuc2V0VmFsdWVzKHZhbHVlcyk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG4gIGNyZWF0ZWQ6IGZ1bmN0aW9uIGNyZWF0ZWQoKSB7XG4gICAgdmFyIF90aGlzNCA9IHRoaXM7XG5cbiAgICB2YXIgaW5uZXJWYWx1ZSA9IHRoaXMuY29ycmVjdFZhbHVlKHRoaXMuZGF0YS52YWx1ZSk7XG4gICAgdGhpcy51cGRhdGVDb2x1bW5WYWx1ZShpbm5lclZhbHVlKS50aGVuKGZ1bmN0aW9uICgpIHtcbiAgICAgIF90aGlzNC4kZW1pdCgnaW5wdXQnLCBpbm5lclZhbHVlKTtcbiAgICB9KTtcbiAgfVxufSk7Il19